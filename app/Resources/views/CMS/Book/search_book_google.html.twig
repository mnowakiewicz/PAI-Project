{% extends 'CMS/Common/base.html.twig' %}

{% block content_wrapper %}
    <div class="col-md-4 col-md-offset-4" id="form-box">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">{% trans %}books.google.add.book{% endtrans %}</h3>
            </div>
            <div class="box-body">
                {{ form_start(form) }}
                {{ form_widget(form) }}
                <button type="submit" id="submit-form" class="btn btn-primary">Search</button>
                {{ form_end(form) }}
            </div>
        </div>
    </div>
    <div class="col-md-8" style="display: none" id="table-box">
        <div class="box">
            <div class="box-body">
                <table id="data-table" class="table table-bordered table-hover dataTable">
                    <thead>
                    <tr>
                        <th>No.</th>
                        <th>Title</th>
                        <th>SubTitle</th>
                        <th>Authors</th>
                        <th>Published</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

{% endblock %}


{% block extra_scripts %}
    {{ parent() }}
    <script>
        var $table = $('#data-table');
        var data;

        $(function () {
            submitForm();
        });
        
        function prepareTable() {
            $("tr[role='row']").each(function () {
                $(this).click(function () {
                    $("tr[role='row'].selected").removeClass('selected')
                    $(this).addClass('selected');
                })
            })
        }

        function submitForm() {
            $('#submit-form').click(function (e) {
                e.preventDefault();
                var form = $("[name='googlebundle_parameters']")[0];
                console.log(form);

                var formData = new FormData(form);

                $.ajax({
                    url: '{{ path('api_googlebooks_get') }}',
                    data: formData,
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    dataType: "json",
                    success: function (data) {
                        this.data = JSON.parse(data);
                        destroyAndCreateDT(JSON.parse(data));
                        $('#form-box').removeClass('col-md-offset-4');
                        $('#table-box').css("display", "block");
                    }
                })
            });
        }

        function destroyAndCreateDT(data){
            this.$table.DataTable().destroy();

            var rows = [];

            // <th>No.</th>
            // <th>Title</th>
            // <th>SubTitle</th>
            // <th>Authors</th>
            // <th>Published</th>

            data.forEach(function (row, index) {
                rows.push([
                    index,
                    row.title,
                    row.subtitle,
                    getAuthors(row.authors),
                    row.publishedDate,
                ])
            });

            createDataTable(rows);
            prepareTable();
        }

        function createDataTable(rows) {
            this.$table.DataTable({
                searching: false,
                paging: true,
                autoWidth: true,
                data: rows
            });
        }

        function getAuthors(rowAuthors) {
            var authors = '';
            console.log(rowAuthors);
            rowAuthors.forEach(function (author, index) {
                if(index == 0){
                    authors = author.fullName;
                } else {
                    authors += " / " + author.fullName ;
                }
            });

            return authors;
        }
    </script>
{% endblock %}